<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tic Tac Toe Online</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    
    <style>
        :root {
            --dark-gradient: linear-gradient(145deg, #020919 0%, #112a5e 100%);
            --glass-bg: rgba(0, 0, 0, 0.2);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary-accent: #0099ff;
            --text-light: #f1f1f1;
            --player-o-color-glow: #00ff7f;
            --player-x-color-glow: #ff00ff;
            --success-green: #4caf50;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; overflow: hidden; }
        body {
            font-family: 'Poppins', sans-serif;
            display: flex;
            justify-content: center; align-items: center;
            background: var(--dark-gradient); color: var(--text-light);
            transition: background 0.5s ease; /* Smooth transition for background changes */
        }
        .screen-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 20px; transition: opacity 0.4s ease, visibility 0.4s;
            visibility: hidden; opacity: 0;
            overflow-y: auto;
            z-index: 1;
        }
        .screen-container.active { visibility: visible; opacity: 1; z-index: 2; }

        #guideScreen { justify-content: flex-start; padding-top: 80px; padding-bottom: 40px; }
        
        #homeScreen .content-wrapper { max-width: 500px; width: 100%; }
        
        .title-container { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 35px; }
        .title-logo { width: 55px; height: 55px; border-radius: 50%; border: 2px solid var(--primary-accent); }
        .main-title { font-size: 2.2rem; font-weight: 700; text-align: center; margin-bottom: 0; }

        .menu-list { display: flex; flex-direction: column; gap: 15px; }
        .menu-item { display: flex; align-items: center; background: var(--glass-bg); padding: 15px; border-radius: 15px; border: 1px solid var(--glass-border); }
        .menu-icon { flex-shrink: 0; width: 55px; height: 55px; background-color: rgba(0,0,0,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 15px; }
        .menu-icon i { font-size: 1.6rem; color: var(--primary-accent); }
        .menu-text { flex-grow: 1; text-align: left; }
        .menu-text h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 3px; }
        .menu-text p { font-size: 0.85rem; color: #ccc; line-height: 1.4; }
        .menu-btn { flex-shrink: 0; padding: 10px 22px; font-size: 0.9rem; font-weight: 600; letter-spacing: 1px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; background: transparent; color: var(--text-light); border: 2px solid var(--primary-accent); }
        .menu-btn:hover { background: var(--primary-accent); color: white; }
        
        .player-stats-container { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 400px; margin-bottom: 15px; padding: 0 5px; }
        .hearts-container { display: flex; gap: 8px; }
        .hearts-container i { font-size: 1.5rem; color: var(--primary-accent); transition: color 0.3s; }
        .hearts-container i.lost { color: #555; }
        #live-clock { font-size: 1.2rem; font-weight: 600; }
        #round-display { font-size: 1.4rem; font-weight: 600; color: var(--text-light); }

        .player-display { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; width: 100%; max-width: 400px; }
        .player-box { width: 120px; height: 120px; background: rgba(0,0,0,0.3); border-radius: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: box-shadow 0.3s ease, border-color 0.3s ease; text-align: center; padding: 5px; }
        .player-box .symbol { font-size: 3.5rem; font-weight: 700; line-height: 1; }
        .player-box .name { font-size: 1rem; font-weight: 500; margin-top: 5px; word-break: break-word; }
        .vs-text { font-size: 2rem; font-weight: 600; color: rgba(255,255,255,0.7); }
        #player1Box { border: 2px solid var(--player-o-color-glow); box-shadow: 0 0 10px var(--player-o-color-glow); }
        #player1Box .symbol { color: var(--player-o-color-glow); }
        #player2Box { border: 2px solid var(--player-x-color-glow); box-shadow: 0 0 10px var(--player-x-color-glow); }
        #player2Box .symbol { color: var(--player-x-color-glow); }
        .player-box.active { box-shadow: 0 0 15px var(--player-o-color-glow), 0 0 25px var(--player-o-color-glow); }
        #player2Box.active { box-shadow: 0 0 15px var(--player-x-color-glow), 0 0 25px var(--player-x-color-glow); }

        #roundStatusText { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.8rem; font-weight: 700; color: white; background: rgba(0,0,0,0.7); padding: 20px 40px; border-radius: 15px; z-index: 15; backdrop-filter: blur(5px); }

        .page-box { background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); border-radius: 20px; padding: 40px 30px; text-align: center; max-width: 400px; width: 100%; }
        #guideScreen .page-box { text-align: left; max-width: 600px; }
        #guideScreen h2 { text-align: center; margin-bottom: 20px; }
        #guideScreen h3 { color: var(--primary-accent); margin-top: 20px; margin-bottom: 5px; }
        #guideScreen p, #guideScreen ol li { color: #ccc; line-height: 1.6; }
        #guideScreen ol { padding-left: 20px; }
        #guideScreen li { margin-bottom: 8px; }

        .text-input { width: 100%; padding: 12px 20px; border: 1px solid var(--glass-border); border-radius: 50px; background: #333; color: var(--text-light); font-size: 1rem; text-align: center; margin-top: 15px; }
        .id-container { margin-top: 15px; padding: 10px 15px; background-color: rgba(0,0,0,0.3); border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        #gameIdDisplay { font-weight: 600; font-size: 1.2rem; word-break: break-all; text-align: left; }
        #copyFeedback { margin-top: 10px; color: var(--success-green); font-weight: 600; }
        .main-btn { cursor: pointer; background-color: var(--primary-accent); color: white; border: none; padding: 15px 35px; font-size: 1.2rem; border-radius: 50px; font-weight: 600; }
        .secondary-btn { background: transparent; color: var(--primary-accent); border: 2px solid var(--primary-accent); padding: 13px 25px; font-size: 1.1rem; border-radius: 50px; font-weight: 600;}
        .back-btn-page { position: absolute; top: 25px; left: 25px; font-size: 1.8rem; z-index: 10; background: none; border: none; color: var(--text-light); cursor: pointer; }
        .hidden { display: none !important; }
        #gameScreen { justify-content: center; }
        .game-board { position: relative; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; max-width: 400px; }
        .cell { width: 100%; aspect-ratio: 1 / 1; background: var(--glass-bg); border-radius: 15px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: clamp(2.5rem, 15vw, 4.5rem); font-weight: 700; }
        .cell.x { color: var(--player-x-color-glow); } .cell.o { color: var(--player-o-color-glow); }
        .game-actions { position: absolute; bottom: 30px; display: flex; flex-wrap: wrap; justify-content: center; gap: 20px 40px; }
        .action-btn { background: none; border: none; color: var(--text-light); font-size: 1.8rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; position: relative; }
        .action-btn span { font-size: 0.8rem; font-weight: 400; }
        .notification-dot { position: absolute; top: 0; right: 10px; width: 12px; height: 12px; background-color: var(--primary-accent); border-radius: 50%; border: 2px solid #1a0000; }
        #winnerBoard { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 20; }
        .winner-message { background: #1e1e1e; border: 1px solid var(--glass-border); padding: 30px 50px; border-radius: 20px; text-align: center; }
        #winnerText { font-size: 2rem; font-weight: 600; margin-bottom: 15px; }
        #gameDurationText { font-size: 0.9rem; color: #ccc; margin-bottom: 25px; }
        .winner-actions { display: flex; gap: 15px; justify-content: center; }
        #chatScreen { background: rgba(2, 9, 25, 0.8); backdrop-filter: blur(5px); justify-content: flex-start; padding: 0; z-index: 10; }
        .chat-header { width: 100%; display: flex; align-items: center; padding: 15px 20px; background-color: rgba(17, 42, 94, 0.7); }
        .chat-header .back-btn { font-size: 1.5rem; margin-right: 20px; }
        .chat-box { flex-grow: 1; width: 100%; padding: 20px; overflow-y: auto; text-align: left; }
        .chat-input-area { width: 100%; display: flex; gap: 10px; padding: 15px; background-color: rgba(17, 42, 94, 0.7); }
        #messageInput { flex-grow: 1; padding: 12px 20px; border: none; border-radius: 50px; background: #333; color: var(--text-light); font-size: 1rem; }
        #sendMessageBtn { background: var(--primary-accent); border: none; border-radius: 50%; width: 50px; height: 50px; color: white; font-size: 1.2rem; cursor: pointer; }
        .chat-message .user-name { font-weight: 600; }
        .my-message .user-name { color: var(--player-o-color-glow); }
        .friend-message .user-name { color: var(--player-x-color-glow); }
    </style>
</head>
<body>
    
    <div id="homeScreen" class="screen-container active">
        <div class="content-wrapper">
            <div class="title-container"><img src="https://files.catbox.moe/fw7s7f.jpg" alt="Game Logo" class="title-logo" id="mainLogo"><h1 class="main-title">Tic Tac Toe</h1></div>
            <div class="menu-list">
                <div class="menu-item"><div class="menu-icon"><i class="fas fa-robot"></i></div><div class="menu-text"><h3>Player vs Bot</h3><p>Challenge a hard-level AI opponent.</p></div><button id="homePlayBotBtn" class="menu-btn">PLAY</button></div>
                <div class="menu-item"><div class="menu-icon"><i class="fas fa-user-friends"></i></div><div class="menu-text"><h3>Player vs Player</h3><p>Play with a friend on the same device.</p></div><button id="homePlayLocalBtn" class="menu-btn">PLAY</button></div>
                <div class="menu-item"><div class="menu-icon"><i class="fas fa-plus-square"></i></div><div class="menu-text"><h3>Create Online Room</h3><p>Host a private match for a friend.</p></div><button id="homeCreateBtn" class="menu-btn">CREATE</button></div>
                <div class="menu-item"><div class="menu-icon"><i class="fas fa-right-to-bracket"></i></div><div class="menu-text"><h3>Join Online Room</h3><p>Enter a room ID to play together.</p></div><button id="homeJoinBtn" class="menu-btn">JOIN</button></div>
                <div class="menu-item"><div class="menu-icon"><i class="fas fa-book-open"></i></div><div class="menu-text"><h3>Game Guide</h3><p>Learn how to play all game modes.</p></div><button id="homeGuideBtn" class="menu-btn">GUIDE</button></div>
            </div>
        </div>
    </div>
    <div id="guideScreen" class="screen-container">
        <button class="back-btn-page backToHome"><i class="fas fa-arrow-left"></i></button>
        <div class="page-box">
            <h2>Game Guide</h2><p style="text-align: center; margin-bottom: 20px;">इस गाइड में गेम के सभी मोड्स को खेलने का तरीका बताया गया है।</p><h3>गेम का लक्ष्य</h3><p>यह एक "Best of 3" मैच है। हर खिलाड़ी 3 दिलों (Lives) के साथ शुरू करता है। हर बार जब आप एक राउंड हारते हैं, तो आपका एक दिल कम हो जाता है। जो खिलाड़ी पहले अपने प्रतिद्वंद्वी के तीनों दिल खत्म कर देता है, वह मैच जीत जाता है!</p><h3>Player vs Bot (खिलाड़ी vs बॉट)</h3><p>इस मोड में आप एक बहुत ही स्मार्ट और अजेय कंप्यूटर (AI) के खिलाफ खेलते हैं। बॉट को हराना लगभग असंभव है, इसलिए आपकी सबसे अच्छी रणनीति ड्रॉ के लिए खेलना है। अपनी दिमागी शक्ति का परीक्षण करें और देखें कि आप कितनी देर तक टिक सकते हैं!</p><h3>Player vs Player (खिलाड़ी vs खिलाड़ी)</h3><p>यह मोड आपके लिए है अगर आप अपने किसी दोस्त या परिवार के सदस्य के साथ एक ही फोन या कंप्यूटर पर खेलना चाहते हैं। एक खिलाड़ी 'O' होगा और दूसरा 'X'। बारी-बारी से अपनी चालें चलें और देखें कि कौन बेहतर खिलाड़ी है।</p><h3>Create Online Room (ऑनलाइन रूम बनाएं)</h3><p>अपने दोस्तों के साथ ऑनलाइन खेलने के लिए इन स्टेप्स का पालन करें:</p><ol><li>होम स्क्रीन पर 'Create Online Room' पर क्लिक करें।</li><li>अपना नाम दर्ज करें और 'Create & Enter' दबाएं।</li><li>आपको एक यूनिक 'Room ID' दिखाई देगी। ID वाले बॉक्स पर क्लिक करें, यह अपने आप कॉपी हो जाएगी।</li><li>यह कॉपी की हुई ID अपने दोस्त को भेजें।</li><li>जब आपका दोस्त ज्वाइन करेगा, तो गेम अपने आप शुरू हो जाएगा।</li></ol><h3>Join Online Room (ऑनलाइन रूम ज्वाइन करें)</h3><p>अगर आपके दोस्त ने आपको एक Room ID भेजी है, तो ऐसे ज्वाइन करें:</p><ol><li>होम स्क्रीन पर 'Join Online Room' पर क्लिक करें।</li><li>पहले बॉक्स में अपने दोस्त की भेजी हुई Room ID डालें।</li><li>दूसरे बॉक्स में अपना नाम दर्ज करें।</li><li>'Join Game' पर क्लिक करें और मैच शुरू हो जाएगा!</li></ol>
        </div>
    </div>
    <div id="createRoomScreen" class="screen-container"><button class="back-btn-page backToHome"><i class="fas fa-arrow-left"></i></button><div class="page-box"><h2>Your Room ID</h2><p>Share this ID, then enter the game.</p><div id="idContainer" class="id-container"><span id="gameIdDisplay">Generating...</span><i class="fas fa-copy"></i></div><p id="copyFeedback" class="hidden">ID Copied!</p><input type="text" id="creatorNameInput" class="text-input" placeholder="Enter Your Name"><button id="createAndEnterGameBtn" class="main-btn" style="margin-top: 25px;">Create & Enter</button></div></div>
    <div id="joinRoomScreen" class="screen-container"><button class="back-btn-page backToHome"><i class="fas fa-arrow-left"></i></button><div class="page-box"><h2>Join Room</h2><div style="display: flex; flex-direction: column; gap: 15px; width: 100%; margin-top: 20px;"><input type="text" id="joinRoomIdInput" class="text-input" placeholder="Enter Friend's Room ID"><input type="text" id="joinerNameInput" class="text-input" placeholder="Enter Your Name"><button id="joinGameBtn" class="main-btn">Join Game</button></div></div></div>
    <div id="gameScreen" class="screen-container">
        <div class="player-stats-container"><div id="player1Hearts" class="hearts-container"></div><div id="round-display">Round 1</div><div id="live-clock">00:00:00 AM</div></div>
        <div class="player-display"><div id="player1Box" class="player-box"><span id="player1Symbol" class="symbol">O</span><span id="player1Name" class="name">Player 1</span></div><span class="vs-text">VS</span><div id="player2Box" class="player-box"><span id="player2Symbol" class="symbol">X</span><span id="player2Name" class="name">Player 2</span></div></div>
        <div class="player-stats-container" style="margin-bottom:20px; margin-top: -10px; justify-content: flex-end;"><div id="player2Hearts" class="hearts-container"></div></div>
        <div class="game-board"><div id="roundStatusText" class="hidden"></div><div class="cell" data-index="0"></div><div class="cell" data-index="1"></div><div class="cell" data-index="2"></div><div class="cell" data-index="3"></div><div class="cell" data-index="4"></div><div class="cell" data-index="5"></div><div class="cell" data-index="6"></div><div class="cell" data-index="7"></div><div class="cell" data-index="8"></div></div>
        <div class="game-actions"><button id="leaveGameBtn" class="action-btn"><i class="fas fa-sign-out-alt"></i><span>Leave</span></button><button id="chatIcon" class="action-btn"><i class="fas fa-comments"></i><span>Chat</span><span class="notification-dot hidden"></span></button></div>
    </div>
    <div id="winnerBoard" class="screen-container"><div class="winner-message"><p id="winnerText"></p><p id="gameDurationText"></p><div class="winner-actions"><button id="requestRematchBtn" class="secondary-btn">Rematch</button><button id="goHomeBtn" class="main-btn">Go Home</button></div></div></div>
    <div id="chatScreen" class="screen-container"><div class="chat-header"><button id="backToGameBtn" class="action-btn back-btn"><i class="fas fa-arrow-left"></i></button><h2>Game Chat</h2></div><div id="chatBox" class="chat-box"></div><div class="chat-input-area"><input type="text" id="messageInput" placeholder="Type a message..."><button id="sendMessageBtn"><i class="fas fa-paper-plane"></i></button></div></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = { apiKey: "AIzaSyDYRSyKxEfw89bb5SO0Gut5rWf3-rS7tm0", authDomain: "online-3aa2b.firebaseapp.com", projectId: "online-3aa2b", storageBucket: "online-3aa2b.firebasestorage.app", messagingSenderId: "591745181174", appId: "1:591745181174:web:c0c13373876220021d13d7" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            const mainLogo = document.getElementById('mainLogo');
            const defaultLogoUrl = "https://files.catbox.moe/fw7s7f.jpg";
            const settingsRef = db.collection('settings').doc('gameConfig');

            settingsRef.onSnapshot((doc) => {
                const body = document.body;
                if (doc.exists) {
                    const settings = doc.data();
                    if (settings.accentColor) { document.documentElement.style.setProperty('--primary-accent', settings.accentColor); }
                    mainLogo.src = settings.logoUrl || defaultLogoUrl;
                    if (settings.backgroundImage) {
                        body.style.backgroundImage = `url(${settings.backgroundImage})`;
                        body.style.backgroundSize = 'cover';
                        body.style.backgroundPosition = 'center';
                        body.style.backgroundRepeat = 'no-repeat';
                    } else if (settings.backgroundColor) {
                        body.style.background = settings.backgroundColor;
                    } else {
                        body.style.backgroundImage = '';
                        body.style.background = '';
                    }
                } else {
                    mainLogo.src = defaultLogoUrl;
                }
            });

            const screens = { home: document.getElementById('homeScreen'), create: document.getElementById('createRoomScreen'), join: document.getElementById('joinRoomScreen'), game: document.getElementById('gameScreen'), winner: document.getElementById('winnerBoard'), chat: document.getElementById('chatScreen'), guide: document.getElementById('guideScreen') };
            const homePlayBotBtn = document.getElementById('homePlayBotBtn');
            const homePlayLocalBtn = document.getElementById('homePlayLocalBtn');
            const homeCreateBtn = document.getElementById('homeCreateBtn');
            const homeJoinBtn = document.getElementById('homeJoinBtn');
            const homeGuideBtn = document.getElementById('homeGuideBtn');
            const createAndEnterGameBtn = document.getElementById('createAndEnterGameBtn');
            const joinGameBtn = document.getElementById('joinGameBtn');
            const idContainer = document.getElementById('idContainer');
            const gameIdDisplay = document.getElementById('gameIdDisplay');
            const copyFeedback = document.getElementById('copyFeedback');
            const joinRoomIdInput = document.getElementById('joinRoomIdInput');
            const creatorNameInput = document.getElementById('creatorNameInput');
            const joinerNameInput = document.getElementById('joinerNameInput');
            const cells = document.querySelectorAll('.cell');
            const winnerText = document.getElementById('winnerText');
            const gameDurationText = document.getElementById('gameDurationText');
            const goHomeBtn = document.getElementById('goHomeBtn');
            const leaveGameBtn = document.getElementById('leaveGameBtn');
            const requestRematchBtn = document.getElementById('requestRematchBtn');
            const backToHomeBtns = document.querySelectorAll('.backToHome');
            const liveClock = document.getElementById('live-clock');
            const player1HeartsContainer = document.getElementById('player1Hearts');
            const player2HeartsContainer = document.getElementById('player2Hearts');
            const roundStatusText = document.getElementById('roundStatusText');
            const roundDisplay = document.getElementById('round-display');
            const player1Box = document.getElementById('player1Box');
            const player2Box = document.getElementById('player2Box');
            const player1Name = document.getElementById('player1Name');
            const player2Name = document.getElementById('player2Name');
            const chatIcon = document.getElementById('chatIcon');
            const chatNotificationDot = document.querySelector('.notification-dot');
            const backToGameBtn = document.getElementById('backToGameBtn');
            const messageInput = document.getElementById('messageInput');
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const chatBox = document.getElementById('chatBox');
            let gameMode = 'online';
            let localGameState = {};
            let currentGameId = null;
            let localPlayerId = localStorage.getItem('playerId') || 'player_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('playerId', localPlayerId);
            let localPlayerSymbol = null;
            let unsubscribeGame = null;
            let unsubscribeChat = null;
            const winningConditions = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
            let liveClockInterval = null;
            let gameStartTime = null;
            const playerSymbol = 'O'; const botSymbol = 'X';

            const formatTime = (date) => { let hours = date.getHours(); let minutes = date.getMinutes(); let seconds = date.getSeconds(); const ampm = hours >= 12 ? 'PM' : 'AM'; hours = hours % 12; hours = hours ? hours : 12; minutes = minutes < 10 ? '0' + minutes : minutes; seconds = seconds < 10 ? '0' + seconds : seconds; return `${hours}:${minutes}:${seconds} ${ampm}`; };
            const updateLiveClock = () => { liveClock.textContent = formatTime(new Date()); };
            const formatDuration = (startTime, endTime) => { const diffSeconds = Math.floor((endTime - startTime) / 1000); const minutes = Math.floor(diffSeconds / 60); const seconds = diffSeconds % 60; let durationString = "Match lasted for "; if (minutes > 0) durationString += `${minutes} minute${minutes > 1 ? 's' : ''} and `; durationString += `${seconds} second${seconds !== 1 ? 's' : ''}.`; return durationString; };
            const showScreen = (screenName) => { Object.values(screens).forEach(screen => screen.classList.remove('active')); if (screens[screenName]) screens[screenName].classList.add('active'); if (screenName === 'game') { if (!liveClockInterval) { updateLiveClock(); liveClockInterval = setInterval(updateLiveClock, 1000); } } else { if (liveClockInterval) { clearInterval(liveClockInterval); liveClockInterval = null; } } };
            const getNewGameState = () => ({ gameState: Array(9).fill(""), currentPlayer: "O", gameActive: true, winner: null, playerOHearts: 3, playerXHearts: 3, round: 1 });
            const startLocalGame = () => { gameMode = 'local'; localGameState = getNewGameState(); chatIcon.classList.add('hidden'); gameStartTime = new Date(); showScreen('game'); updateUI(localGameState); };
            const startBotGame = () => { gameMode = 'bot'; localGameState = getNewGameState(); chatIcon.classList.add('hidden'); gameStartTime = new Date(); showScreen('game'); updateUI(localGameState); };
            const prepareCreateGame = () => { gameMode = 'online'; showScreen('create'); copyFeedback.classList.add('hidden'); const gameRef = db.collection('games').doc(); currentGameId = gameRef.id; gameIdDisplay.textContent = currentGameId; };
            const handleCreateAndEnterGame = () => { const playerName = creatorNameInput.value.trim(); if (!playerName) { alert('Please enter your name.'); return; } const gameRef = db.collection('games').doc(currentGameId); gameRef.set({ ...getNewGameState(), gameActive: false, players: { 'O': { id: localPlayerId, name: playerName }, 'X': null }, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); listenToGameUpdates(currentGameId); showScreen('game'); chatIcon.classList.remove('hidden'); };
            const handleJoinGame = () => { gameMode = 'online'; const gameId = joinRoomIdInput.value.trim(); const playerName = joinerNameInput.value.trim(); if (!gameId || !playerName) { alert('Please enter both Room ID and your name.'); return; } const gameRef = db.collection('games').doc(gameId); gameRef.get().then(doc => { if (doc.exists) { const gameData = doc.data(); if (gameData.players.X && gameData.players.X.id !== localPlayerId) { alert('This room is already full.'); } else { gameRef.update({ 'players.X': { id: localPlayerId, name: playerName }, 'gameActive': true }); listenToGameUpdates(gameId); } } else { alert('Room not found.'); } }); };
            const listenToGameUpdates = (gameId) => {
                currentGameId = gameId; if (unsubscribeGame) unsubscribeGame();
                unsubscribeGame = db.collection('games').doc(gameId).onSnapshot(doc => {
                    if (!doc.exists) { goHome(); return; }
                    const gameData = doc.data();
                    if (gameData.players.X && !gameStartTime) { gameStartTime = new Date(); }
                    if ((screens.join.classList.contains('active') || screens.create.classList.contains('active')) && gameData.players.X) { chatIcon.classList.remove('hidden'); showScreen('game'); }
                    updateUI(gameData);
                });
                listenToChatUpdates(gameId);
            };
            const updateHeartsUI = (oHearts, xHearts) => { player1HeartsContainer.innerHTML = ''; player2HeartsContainer.innerHTML = ''; for(let i=0; i<3; i++) { player1HeartsContainer.innerHTML += `<i class="fas fa-heart ${i >= oHearts ? 'lost' : ''}"></i>`; player2HeartsContainer.innerHTML += `<i class="fas fa-heart ${i >= xHearts ? 'lost' : ''}"></i>`; } };
            const updateUI = (state) => {
                if (!state) return;
                updateHeartsUI(state.playerOHearts, state.playerXHearts);
                roundDisplay.textContent = `Round ${state.round || 1}`;
                player1Box.classList.remove('active'); player2Box.classList.remove('active');
                if (gameMode === 'local') { player1Name.textContent = 'Player 1'; player2Name.textContent = 'Player 2'; } 
                else if (gameMode === 'bot') { player1Name.textContent = 'You'; player2Name.textContent = 'Bot'; }
                else if (gameMode === 'online' && state.players && state.players.O) {
                    localPlayerSymbol = state.players.O.id === localPlayerId ? "O" : "X";
                    const playerOName = state.players.O.name; const playerXName = state.players.X ? state.players.X.name : 'Waiting...';
                    player1Name.textContent = localPlayerSymbol === 'O' ? `${playerOName} (You)` : playerOName;
                    player2Name.textContent = localPlayerSymbol === 'X' ? `${playerXName} (You)` : playerXName;
                }
                if (state.currentPlayer === 'O') player1Box.classList.add('active'); else player2Box.classList.add('active');
                if(state.winner) {
                    if (gameStartTime) { gameDurationText.textContent = formatDuration(gameStartTime, new Date()); } else { gameDurationText.textContent = ""; }
                    showScreen('winner'); let winnerMsg;
                    if (state.winner === 'Draw') { winnerMsg = "It's a Draw!"; }
                    else if (gameMode === 'local') { winnerMsg = `Player ${state.winner === 'O' ? '1' : '2'} Wins!`; }
                    else if (gameMode === 'bot') { winnerMsg = state.winner === playerSymbol ? "You Win!" : "Bot Wins!"; }
                    else { winnerMsg = state.winner === localPlayerSymbol ? "You Win!" : "You Lose!"; }
                    winnerText.textContent = winnerMsg;
                    player1Box.classList.remove('active'); player2Box.classList.remove('active');
                }
                state.gameState.forEach((cellState, index) => { cells[index].textContent = cellState; cells[index].className = 'cell'; if (cellState) cells[index].classList.add(cellState.toLowerCase()); });
                const isMyTurn = (gameMode === 'local' || (gameMode === 'bot' && state.currentPlayer === playerSymbol) || (gameMode === 'online' && state.currentPlayer === localPlayerSymbol));
                cells.forEach(cell => { cell.classList.toggle('disabled', !isMyTurn || !state.gameActive || !!state.winner); });
            };
            const startNextRound = (roundWinner, state) => {
                state.gameActive = false; updateUI(state); let winnerName;
                if(roundWinner === 'Draw') { winnerName = 'Draw'; }
                else if(gameMode === 'bot') { winnerName = roundWinner === playerSymbol ? 'You' : 'Bot'; }
                else if(gameMode === 'local') { winnerName = `Player ${roundWinner === 'O' ? 1 : 2}`; }
                else { winnerName = roundWinner === localPlayerSymbol ? "You" : "Friend"; }
                roundStatusText.textContent = roundWinner === 'Draw' ? `Round ${state.round} is a Draw!` : `${winnerName} won Round ${state.round}!`;
                roundStatusText.classList.remove('hidden'); state.round++;
                setTimeout(() => {
                    state.gameState = Array(9).fill(""); state.currentPlayer = "O"; state.gameActive = true; roundStatusText.classList.add('hidden');
                    updateUI(state);
                    if(gameMode === 'online') { db.collection('games').doc(currentGameId).update({ gameState: state.gameState, currentPlayer: state.currentPlayer, gameActive: state.gameActive, playerOHearts: state.playerOHearts, playerXHearts: state.playerXHearts, round: state.round }); }
                }, 3000);
            };
            const handleRoundEnd = (roundResult, state) => {
                const { roundWon, winner } = roundResult;
                if (roundWon) {
                    if (winner === 'O') state.playerXHearts--; else state.playerOHearts--;
                    if (state.playerOHearts <= 0) state.winner = 'X'; if (state.playerXHearts <= 0) state.winner = 'O';
                    if (state.winner) { updateUI(state); if(gameMode === 'online') db.collection('games').doc(currentGameId).update({ winner: state.winner, gameActive: false, playerOHearts: state.playerOHearts, playerXHearts: state.playerXHearts }); } 
                    else { startNextRound(winner, state); }
                } else { startNextRound('Draw', state); }
            };
            const findBestMove = (board) => { let bestScore = -Infinity; let move = -1; for(let i=0; i<9; i++){ if(board[i] === ""){ board[i] = botSymbol; let score = minimax(board, false); board[i] = ""; if(score > bestScore){ bestScore = score; move = i; } } } return move; };
            const scores = { 'X': 10, 'O': -10, 'draw': 0 };
            const minimax = (board, isMaximizing) => {
                let result = checkWinnerForBot(board); if(result !== null) return scores[result];
                if(isMaximizing){ let bestScore = -Infinity; for(let i=0; i<9; i++){ if(board[i] === ''){ board[i] = botSymbol; let score = minimax(board, false); board[i] = ''; bestScore = Math.max(score, bestScore); } } return bestScore; } 
                else { let bestScore = Infinity; for(let i=0; i<9; i++){ if(board[i] === ''){ board[i] = playerSymbol; let score = minimax(board, true); board[i] = ''; bestScore = Math.min(score, bestScore); } } return bestScore; }
            };
            const checkWinnerForBot = (board) => { for (let condition of winningConditions) { const [a, b, c] = condition; if (board[a] && board[a] === board[b] && board[a] === board[c]) return board[a]; } if (!board.includes("")) return 'draw'; return null; };
            const handleCellClick = (e) => {
                const index = parseInt(e.target.getAttribute('data-index'));
                if (gameMode === 'local' || gameMode === 'bot') {
                    if (localGameState.gameState[index] !== "" || !localGameState.gameActive) return;
                    localGameState.gameState[index] = localGameState.currentPlayer;
                    let roundResult = checkResult(localGameState.gameState);
                    if (roundResult.roundWon || !localGameState.gameState.includes("")) { handleRoundEnd(roundResult, localGameState); return; }
                    localGameState.currentPlayer = localGameState.currentPlayer === "O" ? "X" : "O"; updateUI(localGameState);
                    if (gameMode === 'bot' && localGameState.gameActive) {
                        setTimeout(() => {
                            const botMove = findBestMove(localGameState.gameState);
                            if(botMove !== -1) {
                                localGameState.gameState[botMove] = botSymbol;
                                roundResult = checkResult(localGameState.gameState);
                                if (roundResult.roundWon || !localGameState.gameState.includes("")) { handleRoundEnd(roundResult, localGameState); } 
                                else { localGameState.currentPlayer = playerSymbol; updateUI(localGameState); }
                            }
                        }, 700);
                    }
                } else if (gameMode === 'online') {
                    const gameRef = db.collection('games').doc(currentGameId);
                    gameRef.get().then(doc => {
                        const gameData = doc.data();
                        if (gameData.gameState[index] !== "" || !gameData.gameActive || gameData.currentPlayer !== localPlayerSymbol) return;
                        gameData.gameState[index] = gameData.currentPlayer;
                        const roundResult = checkResult(gameData.gameState);
                        if (roundResult.roundWon || !gameData.gameState.includes("")) { handleRoundEnd(roundResult, gameData); } 
                        else { gameData.currentPlayer = gameData.currentPlayer === "O" ? "X" : "O"; gameRef.update({ gameState: gameData.gameState, currentPlayer: gameData.currentPlayer }); }
                    });
                }
            };
            const handleRequestRematch = () => { if (gameMode === 'local') { startLocalGame(); } else if (gameMode === 'bot') { startBotGame(); } else { const newState = getNewGameState(); gameStartTime = new Date(); db.collection('games').doc(currentGameId).update(newState); showScreen('game'); } };
            const goHome = () => { resetLocalState(); showScreen('home'); };
            const resetLocalState = () => { if (unsubscribeGame) unsubscribeGame(); if (unsubscribeChat) unsubscribeChat(); unsubscribeGame = null; unsubscribeChat = null; currentGameId = null; localPlayerSymbol = null; localGameState = {}; gameStartTime = null; joinRoomIdInput.value = ''; creatorNameInput.value = ''; joinerNameInput.value = ''; chatBox.innerHTML = ''; };
            const checkResult = (currentGameState) => { let roundWon = false; let winner = null; for (let condition of winningConditions) { const [a, b, c] = condition.map(index => currentGameState[index]); if (a && a === b && b === c) { roundWon = true; winner = a; break; } } return { roundWon, winner }; };
            const listenToChatUpdates = (gameId) => {
                if (unsubscribeChat) unsubscribeChat();
                unsubscribeChat = db.collection('games').doc(gameId).collection('chat').orderBy("timestamp").onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            if (!screens.chat.classList.contains('active')) chatNotificationDot.classList.remove('hidden');
                            const msgData = change.doc.data();
                            if(msgData && msgData.text) {
                                const msgElement = document.createElement('div');
                                const isMyMessage = msgData.player === `Player ${localPlayerSymbol}`;
                                msgElement.classList.add('chat-message', isMyMessage ? 'my-message' : 'friend-message');
                                const userName = isMyMessage ? 'You' : 'Friend';
                                msgElement.innerHTML = `<span class="user-name">${userName}:</span> ${msgData.text}`;
                                chatBox.appendChild(msgElement);
                                chatBox.scrollTop = chatBox.scrollHeight;
                            }
                        }
                    });
                });
            };
            
            homePlayBotBtn.addEventListener('click', startBotGame);
            homePlayLocalBtn.addEventListener('click', startLocalGame);
            homeGuideBtn.addEventListener('click', () => showScreen('guide'));
            homeCreateBtn.addEventListener('click', prepareCreateGame);
            homeJoinBtn.addEventListener('click', () => showScreen('join'));
            createAndEnterGameBtn.addEventListener('click', handleCreateAndEnterGame);
            joinGameBtn.addEventListener('click', handleJoinGame);
            const showCopyFeedback = () => { copyFeedback.classList.remove('hidden'); setTimeout(() => copyFeedback.classList.add('hidden'), 2000); };
            const fallbackCopyTextToClipboard = (text) => {
                const textArea = document.createElement("textarea"); textArea.value = text;
                textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.position = "fixed";
                document.body.appendChild(textArea); textArea.focus(); textArea.select();
                try { if (document.execCommand('copy')) showCopyFeedback(); } catch (err) { console.error('Fallback copy failed', err); }
                document.body.removeChild(textArea);
            };
            idContainer.addEventListener('click', () => {
                const gameId = gameIdDisplay.textContent; if (!gameId || gameId === 'Generating...') return;
                if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(gameId).then(showCopyFeedback); } 
                else { fallbackCopyTextToClipboard(gameId); }
            });
            cells.forEach(cell => cell.addEventListener('click', handleCellClick));
            requestRematchBtn.addEventListener('click', handleRequestRematch);
            leaveGameBtn.addEventListener('click', goHome);
            goHomeBtn.addEventListener('click', goHome);
            backToHomeBtns.forEach(btn => btn.addEventListener('click', () => showScreen('home')));
            chatIcon.addEventListener('click', () => { chatNotificationDot.classList.add('hidden'); showScreen('chat'); });
            backToGameBtn.addEventListener('click', () => showScreen('game'));
            messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessageBtn.click(); });
            sendMessageBtn.addEventListener('click', () => { if (!currentGameId) return; const message = messageInput.value.trim(); if (message) { db.collection('games').doc(currentGameId).collection('chat').add({ player: `Player ${localPlayerSymbol}`, text: message, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); messageInput.value = ''; } });
        });
    </script>
</body>
    </html>
